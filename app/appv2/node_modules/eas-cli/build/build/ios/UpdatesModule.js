"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.readChannelSafelyAsync = exports.readReleaseChannelSafelyAsync = exports.syncUpdatesConfigurationAsync = void 0;
const config_plugins_1 = require("@expo/config-plugins");
const projectUtils_1 = require("../../project/projectUtils");
const actions_1 = require("../../user/actions");
const plist_1 = require("../../utils/plist");
const vcs_1 = require("../../vcs");
const updates_1 = require("../utils/updates");
async function syncUpdatesConfigurationAsync(projectDir, exp) {
    (0, updates_1.ensureValidVersions)(exp);
    const accountName = (0, projectUtils_1.getProjectAccountName)(exp, await (0, actions_1.ensureLoggedInAsync)());
    const expoPlist = await readExpoPlistAsync(projectDir);
    const updatedExpoPlist = config_plugins_1.IOSConfig.Updates.setUpdatesConfig(exp, expoPlist, accountName);
    await writeExpoPlistAsync(projectDir, updatedExpoPlist);
}
exports.syncUpdatesConfigurationAsync = syncUpdatesConfigurationAsync;
async function readExpoPlistAsync(projectDir) {
    var _a;
    const expoPlistPath = config_plugins_1.IOSConfig.Paths.getExpoPlistPath(projectDir);
    return ((_a = (await (0, plist_1.readPlistAsync)(expoPlistPath))) !== null && _a !== void 0 ? _a : {});
}
async function writeExpoPlistAsync(projectDir, expoPlist) {
    const expoPlistPath = config_plugins_1.IOSConfig.Paths.getExpoPlistPath(projectDir);
    await (0, plist_1.writePlistAsync)(expoPlistPath, expoPlist);
    await (0, vcs_1.getVcsClient)().trackFileAsync(expoPlistPath);
}
async function readReleaseChannelSafelyAsync(projectDir) {
    var _a;
    try {
        const expoPlist = await readExpoPlistAsync(projectDir);
        return (_a = expoPlist[config_plugins_1.IOSConfig.Updates.Config.RELEASE_CHANNEL]) !== null && _a !== void 0 ? _a : null;
    }
    catch (err) {
        return null;
    }
}
exports.readReleaseChannelSafelyAsync = readReleaseChannelSafelyAsync;
async function readChannelSafelyAsync(projectDir) {
    var _a, _b;
    try {
        // TODO-JJ remove any once IOSConfig.ExpoPlist is updated to include `EXUpdatesRequestHeaders : Record<string,string>`
        const expoPlist = await readExpoPlistAsync(projectDir);
        //TODO-JJ 'EXUpdatesRequestHeaders' IosConfig.Updates.Config.UPDATES_CONFIGURATION_REQUEST_HEADERS_KEY once https://github.com/expo/expo-cli/pull/3571 is published
        const updatesRequestHeaders = (_a = expoPlist['EXUpdatesRequestHeaders']) !== null && _a !== void 0 ? _a : {};
        return (_b = updatesRequestHeaders['expo-channel-name']) !== null && _b !== void 0 ? _b : null;
    }
    catch (err) {
        return null;
    }
}
exports.readChannelSafelyAsync = readChannelSafelyAsync;
